# yaml
version: "3.8"
services:
  metabase_db:
    image: postgres:15
    ports:
      - "5432:5432"
    environment:
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: admin
      POSTGRES_DB: metabase_app
    volumes:
      - mb_pgdata:/var/lib/postgresql/data
    restart: unless-stopped

  metabase:
    image: metabase/metabase
    ports:
      - "3000:3000"
    environment:
      MB_DB_TYPE: postgres
      MB_DB_HOST: metabase_db
      MB_DB_PORT: 5432
      MB_DB_DBNAME: metabase_app
      MB_DB_USER: admin
      MB_DB_PASS: admin

      # Cấu hình tài khoản đăng nhập vào metabase
#      MB_SITE_URL: http://localhost:3000
#      MB_SETUP_ADMIN_EMAIL: phat123@gmail.com
#      MB_SETUP_ADMIN_FIRST_NAME: Admin
#      MB_SETUP_ADMIN_LAST_NAME: Local
#      MB_SETUP_ADMIN_PASSWORD: Admin123@
#      MB_ENCRYPTION_SECRET_KEY: "this_is_a_very_long_random_key_1234567890"
    depends_on:
      - metabase_db
    restart: unless-stopped

  ingest:
    build: ./ingest
    command: ["python", "ingest.py"]
    environment:
      DATABASE_URL: "mysql+pymysql://aff_admin:affina_poOB7G9A51@172.16.10.32:3306/profiling_analysis"

  streamlit:
    build: ./streamlit
    ports:
      - "8501:8501"
    environment:
      DATABASE_URL: "mysql+pymysql://aff_admin:affina_poOB7G9A51@172.16.10.32:3306/profiling_analysis"

  mcp_placeholder:
    image: alpine
    command: ["sh", "-c", "echo MCP placeholder - configure MCP to run the ingest job"]
    # Replace this with your real MCP integration / scheduler

volumes:
  mb_pgdata:

